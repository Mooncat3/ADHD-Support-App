name: Auto Merge Only Non-Empty Commits to Main

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  cherry_pick_and_merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Set up Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch main
        run: git fetch origin main

      - name: Create temp branch from main
        run: |
          git checkout -B tmp-non-empty-merge origin/main

      - name: Cherry-pick only non-empty commits
        run: |
          COMMITS=$(git rev-list --reverse origin/main..origin/${{ github.head_ref }})

          for COMMIT in $COMMITS; do
            if [ "$(git show --pretty="" --name-only $COMMIT | wc -l)" -gt 0 ]; then
              echo "‚úÖ Cherry-pick: $COMMIT"
              git cherry-pick "$COMMIT"
            else
              echo "‚è≠ –ü—É—Å—Ç–æ–π –∫–æ–º–º–∏—Ç –ø—Ä–æ–ø—É—â–µ–Ω: $COMMIT"
            fi
          done

      - name: Push directly to main
        run: |
          git push origin HEAD:main
          echo "üöÄ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å –Ω–µ–ø—É—Å—Ç—ã–º–∏ –∫–æ–º–º–∏—Ç–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ main"
